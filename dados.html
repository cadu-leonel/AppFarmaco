<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dados de Desempenho</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #6A8EDD;
      --secondary: #66C2E0;
      --danger: #E74C3C;
      --background: #121212;
      --text: #E0E0E0;
      --card-bg: #1E1E1E;
      --border: #333333;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--background);
      color: var(--text);
      margin: 0;
      padding: 2rem;
    }
    /* Login */
    .login-container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 10px;
      max-width: 420px;
      margin: 2rem auto;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .login-container h1 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .login-input {
      width: 100%;
      padding: 1rem;
      margin: 0.5rem 0;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text);
    }
    .login-button {
      width: 100%;
      padding: 1rem;
      margin-top: 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .error-message {
      color: var(--danger);
      text-align: center;
      margin-top: 1rem;
      display: none;
    }

    /* Conte√∫do principal */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: none;
    }
    .logout-btn {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    h1 {
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 2rem;
    }
    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: var(--primary);
      color: white;
    }
    tr:hover {
      background: #2a2a2a;
    }
    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    button {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:hover {
      opacity: 0.9;
    }
    .export-btn {
      background: var(--secondary);
      color: #0b0b0b;
    }
    .pdf-btn {
      background: var(--danger);
      color: #fff;
    }
    .no-data {
      text-align: center;
      padding: 2rem;
      color: #aaa;
      border: 2px dashed var(--border);
      border-radius: 8px;
      margin: 2rem 0;
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginContainer" class="login-container">
    <h1>Acesso Restrito</h1>
    <input type="text" id="username" class="login-input" placeholder="Usu√°rio">
    <input type="password" id="password" class="login-input" placeholder="Senha">
    <button class="login-button" onclick="login()">Entrar</button>
    <div class="error-message" id="loginError">Credenciais inv√°lidas!</div>
  </div>

  <!-- Conte√∫do -->
  <div class="container" id="mainContainer">
    <button class="logout-btn" onclick="logout()">Sair</button>
    <h1>üìä Dados de Desempenho</h1>
    <div id="dataTable"></div>
    <div class="actions">
      <button onclick="clearData()">üßπ Limpar Dados</button>
      <button class="export-btn" onclick="exportData()">üì§ Exportar JSON</button>
      <button class="pdf-btn" onclick="exportPDF()">üìÑ Exportar PDF</button>
      <button onclick="window.location.href = 'index.html'">üè† Voltar</button>
    </div>
  </div>

  <script>
    // jsPDF
    window.jsPDF = window.jspdf.jsPDF;

    // Inicializa√ß√£o ao carregar
    document.addEventListener('DOMContentLoaded', checkAuth);

    // --------- Autentica√ß√£o ----------
    function checkAuth() {
      const isAuth = localStorage.getItem('autenticado') === 'true';
      document.getElementById('loginContainer').style.display = isAuth ? 'none' : 'block';
      document.getElementById('mainContainer').style.display = isAuth ? 'block' : 'none';
      if (isAuth) loadData();
    }

    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (username === 'admin' && password === 'admin') {
        localStorage.setItem('autenticado', 'true');
        document.getElementById('loginError').style.display = 'none';
        checkAuth();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }

    function logout() {
      localStorage.removeItem('autenticado');
      document.getElementById('dataTable').innerHTML = '';
      checkAuth();
    }

    // --------- Utilidades ----------
    function formatTime(seconds) {
      const mins = Math.floor((seconds ?? 0) / 60);
      const secs = (seconds ?? 0) % 60;
      return `${mins}m ${secs}s`;
    }

    function getDisplayName(entry) {
      // tenta encontrar o nome em m√∫ltiplos formatos
      return (
        (entry.user && (entry.user.name || entry.user.nome)) ||
        (typeof entry.user === 'string' ? entry.user : null) ||
        localStorage.getItem('usuarioNome') || // fallback de vers√µes antigas do app
        'N/A'
      );
    }

    // --------- Dados / Tabela ----------
    function loadData() {
      const data = JSON.parse(localStorage.getItem('performanceData')) || [];
      const container = document.getElementById('dataTable');

      if (data.length === 0) {
        container.innerHTML = `<div class="no-data">Nenhum dado de desempenho encontrado</div>`;
        return;
      }

      let html = `<table>
        <thead>
          <tr>
            <th>Aluno</th>
            <th>Data</th>
            <th>Cards</th>
            <th>‚úÖ Acertos</th>
            <th>‚ùå Erros</th>
            <th>‚è± Tempo</th>
            <th>üéØ Taxa</th>
          </tr>
        </thead>
        <tbody>`;

      data.forEach((entry) => {
        const name = getDisplayName(entry);
        const total = entry?.stats?.total ?? 0;
        const correct = entry?.stats?.correct ?? 0;
        const incorrect = (entry?.stats?.incorrect != null) ? entry.stats.incorrect : (total - correct);
        const dateStr = entry?.date ? new Date(entry.date).toLocaleDateString() : '-';
        const totalTime = entry?.stats?.totalTime ?? 0;
        const accuracy = entry?.stats?.accuracy ?? (total ? `${((correct / total) * 100).toFixed(1)}%` : '0%');

        html += `<tr>
          <td>${name}</td>
          <td>${dateStr}</td>
          <td>${total}</td>
          <td>${correct}</td>
          <td>${incorrect}</td>
          <td>${formatTime(totalTime)}</td>
          <td>${accuracy}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function clearData() {
      if (confirm('‚ö†Ô∏è Tem certeza que deseja apagar TODOS os dados?')) {
        localStorage.removeItem('performanceData');
        loadData();
      }
    }

    function exportData() {
      const data = JSON.parse(localStorage.getItem('performanceData')) || [];
      if (data.length === 0) {
        alert('Nenhum dado para exportar!');
        return;
      }

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `desempenho-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // --------- Exportar PDF ----------
    function exportPDF() {
      const data = JSON.parse(localStorage.getItem('performanceData')) || [];
      if (data.length === 0) {
        alert('Nenhum dado para exportar!');
        return;
      }

      const doc = new jsPDF();
      let y = 20;
      const margin = 20;
      const line = 7;

      doc.setFontSize(18);
      doc.text("Relat√≥rio de Desempenho", margin, 15);
      doc.setFontSize(12);
      doc.text(`Gerado em: ${new Date().toLocaleDateString()}`, margin, 25);

      data.forEach((entry, idx) => {
        const name = getDisplayName(entry);
        const total = entry?.stats?.total ?? 0;
        const correct = entry?.stats?.correct ?? 0;
        const incorrect = (entry?.stats?.incorrect != null) ? entry.stats.incorrect : (total - correct);
        const totalTime = entry?.stats?.totalTime ?? 0;
        const accuracy = entry?.stats?.accuracy ?? (total ? `${((correct / total) * 100).toFixed(1)}%` : '0%');
        const dateStr = entry?.date ? new Date(entry.date).toLocaleDateString() : '-';

        y += 15;
        if (y > 280) {
          doc.addPage();
          y = 20;
        }

        doc.setFontSize(14);
        doc.text(`Sess√£o ${idx + 1}`, margin, y);
        y += 10;

        const lines = [
          `Nome: ${name}`,
          `Data: ${dateStr}`,
          `Total de Cards: ${total}`,
          `Acertos: ${correct}`,
          `Erros: ${incorrect}`,
          `Tempo Total: ${formatTime(totalTime)}`,
          `Taxa de Acerto: ${accuracy}`
        ];

        doc.setFontSize(12);
        lines.forEach(t => {
          y += line;
          doc.text(t, margin, y);
        });

        y += 10;
        doc.line(margin, y, 190, y);
      });

      doc.save(`relatorio-${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // Se j√° estiver autenticado (p√≥s-refresh), carrega direto
    if (localStorage.getItem('autenticado') === 'true') {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'block';
      loadData();
    }
  </script>
</body>
</html>
